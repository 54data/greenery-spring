<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.mycompany.miniproject.dao.ReviewDao" >
	
	<select id="getReviewImgById" resultType="Review" parameterType="int">
		select review_id, product_id, order_id, review_img, review_img_type, review_img_name
		from review
		where review_id = #{review_id}
		order by review_reg_date desc
	</select>
	
	 
 	<select id="getReviewsById" resultType="Review">
	    <![CDATA[
	    select review_id, product_id, order_id, user_id, review_content, review_reg_date, 
	           review_score, review_img, review_img_type, review_img_name
	    from (
	        select rownum as rnum, review_id, product_id, order_id, user_id, review_content, review_reg_date, 
	               review_score, review_img, review_img_type, review_img_name
	        from review
	        where product_id = #{productId}
	        and rownum <= #{pager.endRowNo}  
	        order by review_reg_date desc
	    )
	    where rnum >= #{pager.startRowNo}  
	    ]]>
	</select>
    
	<select id="countRows" resultType="int">
	    select count(*) from review where product_id = #{productId} 
	</select>
	
	<insert id="insertReview" parameterType="Review">
	    INSERT INTO review (review_id, product_id, user_id, review_content, review_reg_date, review_score
	        <if test="orderId != null">, order_id</if>
	        <if test="reviewImg != null">, review_img</if>
	        <if test="reviewImgType != null">, review_img_type</if>
	        <if test="reviewImgName != null">, review_img_name</if>
	    )
	    VALUES (review_seq.nextval, #{productId}, #{userId}, #{reviewContent}, sysdate, #{reviewScore}
	        <if test="orderId != null">, #{orderId}</if>
	        <if test="reviewImg != null">, #{reviewImg}</if>
	        <if test="reviewImgType != null">, #{reviewImgType}</if>
	        <if test="reviewImgName != null">, #{reviewImgName}</if>
	    )
	</insert>
	
	<select id="countUserReviewForProduct" parameterType="map" resultType="int">
	    SELECT COUNT(*) FROM review 
	    WHERE user_id = #{userId} 
	    AND orderId = #{orderId}
	</select>
	
	<delete id="deleteReviewById" parameterType="int">
	    DELETE FROM review WHERE review_id = #{reviewId}
	</delete>
	
</mapper>